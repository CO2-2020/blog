<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue2.x和Vue3.x渲染器的diff算法 | CO2-blog</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/blog/favicon.ico">
    <meta name="description" content="Just playing around">
    <link rel="preload" href="/blog/assets/css/0.styles.19f3a7f1.css" as="style"><link rel="preload" href="/blog/assets/js/app.debabb2d.js" as="script"><link rel="preload" href="/blog/assets/js/2.9886cf03.js" as="script"><link rel="preload" href="/blog/assets/js/4.251b1637.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.6e867e0e.js"><link rel="prefetch" href="/blog/assets/js/11.5aff53f7.js"><link rel="prefetch" href="/blog/assets/js/12.e37322e4.js"><link rel="prefetch" href="/blog/assets/js/13.45a1678d.js"><link rel="prefetch" href="/blog/assets/js/14.45900f27.js"><link rel="prefetch" href="/blog/assets/js/15.b30ea6de.js"><link rel="prefetch" href="/blog/assets/js/16.722febf3.js"><link rel="prefetch" href="/blog/assets/js/17.b8f510c1.js"><link rel="prefetch" href="/blog/assets/js/18.60d37e49.js"><link rel="prefetch" href="/blog/assets/js/19.796da14d.js"><link rel="prefetch" href="/blog/assets/js/20.624b603a.js"><link rel="prefetch" href="/blog/assets/js/21.be54a0d6.js"><link rel="prefetch" href="/blog/assets/js/22.76d755cf.js"><link rel="prefetch" href="/blog/assets/js/23.9f148c75.js"><link rel="prefetch" href="/blog/assets/js/24.6f4c2272.js"><link rel="prefetch" href="/blog/assets/js/25.9bfb44b7.js"><link rel="prefetch" href="/blog/assets/js/26.f7b21fbe.js"><link rel="prefetch" href="/blog/assets/js/27.64727a36.js"><link rel="prefetch" href="/blog/assets/js/28.4140139f.js"><link rel="prefetch" href="/blog/assets/js/29.e1b7eca0.js"><link rel="prefetch" href="/blog/assets/js/3.c63dae45.js"><link rel="prefetch" href="/blog/assets/js/30.6d6aef07.js"><link rel="prefetch" href="/blog/assets/js/31.1a34d757.js"><link rel="prefetch" href="/blog/assets/js/32.76c29810.js"><link rel="prefetch" href="/blog/assets/js/33.1e68fd3f.js"><link rel="prefetch" href="/blog/assets/js/34.0efecfd1.js"><link rel="prefetch" href="/blog/assets/js/35.b1126bc8.js"><link rel="prefetch" href="/blog/assets/js/36.88a702cb.js"><link rel="prefetch" href="/blog/assets/js/37.67632e31.js"><link rel="prefetch" href="/blog/assets/js/38.dc4b4a1f.js"><link rel="prefetch" href="/blog/assets/js/39.ea7c4521.js"><link rel="prefetch" href="/blog/assets/js/40.ffa2bdae.js"><link rel="prefetch" href="/blog/assets/js/41.d4da701a.js"><link rel="prefetch" href="/blog/assets/js/42.3f02fb86.js"><link rel="prefetch" href="/blog/assets/js/43.fdf92758.js"><link rel="prefetch" href="/blog/assets/js/44.a3981717.js"><link rel="prefetch" href="/blog/assets/js/45.70ad1b7e.js"><link rel="prefetch" href="/blog/assets/js/46.6791281c.js"><link rel="prefetch" href="/blog/assets/js/47.3928ff3c.js"><link rel="prefetch" href="/blog/assets/js/48.2f6cd282.js"><link rel="prefetch" href="/blog/assets/js/49.ced7c643.js"><link rel="prefetch" href="/blog/assets/js/5.fdf36b4f.js"><link rel="prefetch" href="/blog/assets/js/50.7ddfd4dd.js"><link rel="prefetch" href="/blog/assets/js/51.f3f1522b.js"><link rel="prefetch" href="/blog/assets/js/52.a9ec54b2.js"><link rel="prefetch" href="/blog/assets/js/53.5f174a6e.js"><link rel="prefetch" href="/blog/assets/js/54.7951c2c1.js"><link rel="prefetch" href="/blog/assets/js/55.ed5778cf.js"><link rel="prefetch" href="/blog/assets/js/56.17a2e1b5.js"><link rel="prefetch" href="/blog/assets/js/57.8fedf194.js"><link rel="prefetch" href="/blog/assets/js/58.a4b50389.js"><link rel="prefetch" href="/blog/assets/js/59.9d8096c5.js"><link rel="prefetch" href="/blog/assets/js/6.3eb62b47.js"><link rel="prefetch" href="/blog/assets/js/60.57735b36.js"><link rel="prefetch" href="/blog/assets/js/61.e3267ef7.js"><link rel="prefetch" href="/blog/assets/js/7.8f25fbec.js"><link rel="prefetch" href="/blog/assets/js/8.682d7c8a.js"><link rel="prefetch" href="/blog/assets/js/9.f4820818.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.19f3a7f1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">CO2-blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/blog/adancedJs/" class="nav-link">
  JavaScript
</a></div><div class="nav-item"><a href="/blog/wheels/" class="nav-link">
  手写系列
</a></div><div class="nav-item"><a href="/blog/cssSecret/" class="nav-link">
  CSS/图形学
</a></div><div class="nav-item"><a href="/blog/frameworks/" class="nav-link">
  框架
</a></div><div class="nav-item"><a href="/blog/engineering/" class="nav-link">
  工程化
</a></div><div class="nav-item"><a href="/blog/executionEnvironment/" class="nav-link">
  执行环境
</a></div><div class="nav-item"><a href="/blog/soundcode/" class="nav-link router-link-active">
  源码分析
</a></div><div class="nav-item"><a href="/blog/business/" class="nav-link">
  业务场景
</a></div><div class="nav-item"><a href="/blog/bookNotes/" class="nav-link">
  读书
</a></div><div class="nav-item"><a href="https://github.com/CO2-2020" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/blog/adancedJs/" class="nav-link">
  JavaScript
</a></div><div class="nav-item"><a href="/blog/wheels/" class="nav-link">
  手写系列
</a></div><div class="nav-item"><a href="/blog/cssSecret/" class="nav-link">
  CSS/图形学
</a></div><div class="nav-item"><a href="/blog/frameworks/" class="nav-link">
  框架
</a></div><div class="nav-item"><a href="/blog/engineering/" class="nav-link">
  工程化
</a></div><div class="nav-item"><a href="/blog/executionEnvironment/" class="nav-link">
  执行环境
</a></div><div class="nav-item"><a href="/blog/soundcode/" class="nav-link router-link-active">
  源码分析
</a></div><div class="nav-item"><a href="/blog/business/" class="nav-link">
  业务场景
</a></div><div class="nav-item"><a href="/blog/bookNotes/" class="nav-link">
  读书
</a></div><div class="nav-item"><a href="https://github.com/CO2-2020" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/blog/soundcode/vue/dom-diff" class="sidebar-heading clickable open active"><span>vue</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/soundcode/vue/dom-diff.html" class="active sidebar-link">Vue2.x和Vue3.x渲染器的diff算法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/soundcode/vue/dom-diff.html#dom-diff概述" class="sidebar-link">dom-diff概述</a></li><li class="sidebar-sub-header"><a href="/blog/soundcode/vue/dom-diff.html#vue2-x-diff算法" class="sidebar-link">Vue2.x diff算法</a></li><li class="sidebar-sub-header"><a href="/blog/soundcode/vue/dom-diff.html#vue3-x-diff算法" class="sidebar-link">Vue3.x diff算法</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/soundcode/webpack/webpack5" class="sidebar-heading clickable"><span>webpack</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue2-x和vue3-x渲染器的diff算法"><a href="#vue2-x和vue3-x渲染器的diff算法" class="header-anchor">#</a> Vue2.x和Vue3.x渲染器的diff算法</h1> <h2 id="dom-diff概述"><a href="#dom-diff概述" class="header-anchor">#</a> dom-diff概述</h2> <p><strong>比较只会在同层级进行, 不会跨层级比较</strong> <img src="data:image/png;base64,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" alt="dom-diff1"></p> <h2 id="vue2-x-diff算法"><a href="#vue2-x-diff算法" class="header-anchor">#</a> Vue2.x diff算法</h2> <h3 id="_1-vue2-x-dom-diff算法核心源码"><a href="#_1-vue2-x-dom-diff算法核心源码" class="header-anchor">#</a> 1.vue2.x dom-diff算法核心源码</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//旧节点开始index</span>
      <span class="token keyword">var</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//新节点开始index</span>
      <span class="token keyword">var</span> oldEndIdx <span class="token operator">=</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//旧节点结束index</span>
      <span class="token keyword">var</span> oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//旧节点开始节点VNode</span>
      <span class="token keyword">var</span> oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//旧节点结束节点</span>
      <span class="token keyword">var</span> newEndIdx <span class="token operator">=</span> newCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//新节点结束index</span>
      <span class="token keyword">var</span> newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//新节点开始节点VNode</span>
      <span class="token keyword">var</span> newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//新节点结束虚拟节点VNode</span>

      <span class="token comment">//核心dom-diff 算法</span>
      <span class="token comment">//新旧节点两个指针，做比较</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//1.旧开始节点 === undefined</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">//2.旧结束节点 === undefined</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">//3.旧开始节点 === 新开始节点</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
          oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
          newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
          
      <span class="token comment">//4.旧结束节点 === 新结束节点</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
          oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
          newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
          
      <span class="token comment">//5.旧开始节点 === 新结束节点</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
          <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">//操作真实dom:将老开始节点放置在老结束节点的后面,占了老节点的结束节点位置</span>
          canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
          newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
          
      <span class="token comment">//6.旧结束节点 === 新开始节点</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
          <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
         
          <span class="token comment">//操作真实dom：将结束节点放置在开始节点前面，因为这里指针有移动，作用就是原本的位置</span>
          canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
          oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
          newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
          
      <span class="token comment">//7.都不是</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldKeyToIdx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token comment">//返回老节点的key-index的映射表</span>
            oldKeyToIdx <span class="token operator">=</span> <span class="token function">createKeyToOldIdx</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span> 
          <span class="token punctuation">}</span>

          idxInOld <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
            <span class="token operator">?</span> oldKeyToIdx<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">]</span>
            <span class="token operator">:</span> <span class="token function">findIdxInOld</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">//index不存在，就是新增的元素</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>idxInOld<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            
            <span class="token comment">//实操dom：新增VNode,并且添加到dom中</span>
            <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//不是新增元素，则移动</span>
            <span class="token comment">//需要移动的VNode</span>
            vnodeToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">//比较需要移动的VNode和现在新开始节点是否相同</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">//打补丁，以及遍历子节点</span>
              <span class="token function">patchVnode</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">//将老虚拟dom此处的VNode删除</span>
              oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
           	 <span class="token comment">//实操dom</span>
              canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnodeToMove<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">/*
        1.如果开始下标大于结束下标，说明遍历老节点遍历结束
        2.老节点遍历完毕，新节点的下标+1的值，添加进去
        3.如果新节点遍历完了，就删除老节点中开始到结束下标的值
      */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&gt;</span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        refElm <span class="token operator">=</span> <span class="token function">isUndef</span><span class="token punctuation">(</span>newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>elm<span class="token punctuation">;</span>
        <span class="token function">addVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">,</span> newEndIdx<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartIdx <span class="token operator">&gt;</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//老的没有遍历完，新的遍历完了</span>
        <span class="token comment">//删除老的的节点，从start开始，end结束，包括end</span>
        <span class="token comment">//这里原先移动了节点，用undefined占位，直接删除不影响任何节点</span>
        <span class="token function">removeVnodes</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br></div></div><h3 id="_2-整体逻辑图"><a href="#_2-整体逻辑图" class="header-anchor">#</a> 2. 整体逻辑图</h3> <p><img src="/blog/assets/img/dom-diff2.dbdd54b6.jpg" alt="dom-diff2"></p> <h3 id="_3-案例分析"><a href="#_3-案例分析" class="header-anchor">#</a> 3.案例分析</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>realDom
<span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span> <span class="token number">10</span>
<span class="token comment">//old VNode</span>
l                           r
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>
<span class="token comment">//new VNode</span>
a                             b
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>**
<strong>注意这里比较的都是虚拟dom节点：真实dom的移动不影响虚拟dom节点值，可参照动图一起看</strong></p> <p><img src="/blog/assets/img/vue2-dom-diff.e6ee7e1e.gif" alt="vue2-dom-diff"></p> <ol><li>新旧头比较，直到第一个不相同的节点： <code>l</code> 和 <code>a</code> 都向右移动一位 ，都为1</li> <li>新旧尾比较，直到第一个不相同的节点： <code>r</code> 和 <code>b</code> 都向左移动一位，都为9</li> <li>旧头和新尾比较，相同的话，开始移动真实的dom：
<ul><li>**旧头真实dom移动到旧尾紧跟其后的兄弟节点的前面：**<strong>真实dom中，2移动到10前面，原生节点插入方式实现</strong></li> <li>指针移动：旧开始指针向右移动一位，新结束指针向左移动一位 此时， <code>l</code> 变成了2， <code>b</code>  变成了8</li> <li>此时的真实dom为： <code>1 3 4 5 6 7 8 9 2 10</code></li></ul></li> <li>旧尾和新头比较，相同的话，移动真实dom：
<ul><li><strong>旧尾真实dom移动到旧头节点的el的前面：真实dom中，9移动到3的前面</strong></li> <li>旧尾指针向左移动一位，新头指针向右移动一位，此时， <code>a</code> 变成了2，  <code>r</code> 变成了8</li> <li>此时的真实dom为： <code>1 9 3 4 5 6 7 8 2 10</code></li></ul></li> <li>此时四个指针已经不满足上面四种情况了，就需要进一步处理
<ol><li>首先<strong>遍历剩余老节点</strong>，返回一个 <code>key:oldIndex</code> 映射表</li> <li>新节点的开始节点在这个映射表中能找到对应的oldIndex，说明在老节点中存在这个节点，只需要移动即可</li> <li>如果不存在，则需要新建节点，并且插入到指定的位置</li></ol></li></ol> <p>接着分析案例：</p> <ul><li>剩下的老节点为： <code>[3, 4, 5, 6, 7, 8]</code>  映射表为 <code>{3: 2, 4: 3, 5: 4, 6: 5, 7: 6, 8: 7}</code> 
剩下的新节点的为 <code>[11, 7, 3, 4, 5, 6]</code>  此时 <code>11</code> 在映射表中，没有查询到，说明是新增的节点</li> <li>新增节点  <code>11</code>  ，通过 <code>createElm</code> 函数创建真实dom，并且插入到旧开始节点el指向的真实dom前面。此时旧开始节点是 <code>3</code> ,真实dom中 <code>11</code> 插入到 <code>3</code> 的前面。</li> <li>新开始指针向右移动一位， <code>a</code> 变成3</li> <li>此时的真实dom :<code>1 9 11 3 4 5 6 7 8 2 10</code></li></ul> <ol start="6"><li>接着分析：此时老节点剩余 <code>3,4,5,6,7,8</code> 新节点剩余 <code>7,3,4,5,6</code> 此时又符合情况五。
<ul><li>先找到 <code>7</code> 在老节点的 <code>index</code> ,根据映射表， <code>oldIndex</code> 为 <code>6</code> 说明在老节点中存在，只需要移动</li> <li>将 <code>7</code> 真实dom中的el移动到老开始节点的el前面，也就是真实dom中3的前面</li> <li>将老节点中 <code>oldIndex</code> 这个节点设置为 <code>undefined</code> ，后面会讲作用</li> <li>新开始指针向右移动一位， <code>a</code> 变成了4</li> <li>此时的真实dom :<code>1 9 11 7 3 4 5 6 8 2 10</code></li></ul></li> <li>此时老节点剩余 <code>3,4,5,6,7,8</code> 新节点剩余 <code>3,4,5,6</code> 此时符合情况一，头头比较，遍历完新节点，循环结束</li> <li>接下来是循环结束后的处理，也就是查看新旧节点是否都完全遍历
<ol><li>此时旧节点还未完全遍历，剩下 <code>7,8</code> ,说明这是需要删除的节点</li> <li>因为 <code>7</code> 是被移动的节点，在移动之后，将其虚拟节点数组中的位置设置成了 <code>undefined</code> 避免了后续将其删除</li> <li>根据 <code>8</code> 虚拟节点的elm属性，将其真实dom中的el删除</li></ol></li></ol> <p>总结：整个Vue2.x的dom-diff过程就完成了，需要注意的几点是，</p> <ol><li>双指针遍历的是，新旧的虚拟节点数组，不是真实dom</li> <li>老节点都有elm属性，指向真实的节点，节点的插入和删除都是依靠这个属性</li> <li>Vue2.x尽可能在复用原本的dom</li> <li>尽量使用key，在不使用key时，所有的节点对比都是相同的，对比情况都是走的头头比较，节点都是直接对比然后进行修改处理，比复用移动老节点效率低。</li></ol> <h2 id="vue3-x-diff算法"><a href="#vue3-x-diff算法" class="header-anchor">#</a> Vue3.x diff算法</h2> <h3 id="_1-vue3-x-dom-diff-核心源码"><a href="#_1-vue3-x-dom-diff-核心源码" class="header-anchor">#</a> 1. Vue3.x dom-diff 核心源码</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>
      <span class="token keyword">const</span> <span class="token function-variable function">patchKeyedChildren</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentAnchor<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> isSVG<span class="token punctuation">,</span> optimized</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> l2 <span class="token operator">=</span> c2<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">let</span> e1 <span class="token operator">=</span> c1<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// prev ending index</span>
        <span class="token keyword">let</span> e2 <span class="token operator">=</span> l2 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// next ending index</span>
        <span class="token comment">// 1. sync from start</span>
        <span class="token comment">// (a b) c</span>
        <span class="token comment">// (a b) d e</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> n1 <span class="token operator">=</span> c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> n2 <span class="token operator">=</span> <span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> optimized
                <span class="token operator">?</span> <span class="token function">cloneIfMounted</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token operator">:</span> <span class="token function">normalizeVNode</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">patch</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentAnchor<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> isSVG<span class="token punctuation">,</span> optimized<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2. sync from end</span>
        <span class="token comment">// a (b c)</span>
        <span class="token comment">// d e (b c)</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取末尾的值</span>
            <span class="token keyword">const</span> n1 <span class="token operator">=</span> c1<span class="token punctuation">[</span>e1<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> n2 <span class="token operator">=</span> <span class="token punctuation">(</span>c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span> <span class="token operator">=</span> optimized
                <span class="token operator">?</span> <span class="token function">cloneIfMounted</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token operator">:</span> <span class="token function">normalizeVNode</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">patch</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentAnchor<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> isSVG<span class="token punctuation">,</span> optimized<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            e1<span class="token operator">--</span><span class="token punctuation">;</span>
            e2<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3. common sequence + mount</span>
        <span class="token comment">// (a b)</span>
        <span class="token comment">// (a b) c</span>
        <span class="token comment">// i = 2, e1 = 1, e2 = 2</span>
        <span class="token comment">// (a b)</span>
        <span class="token comment">// c (a b)</span>
        <span class="token comment">// i = 0, e1 = -1, e2 = 0</span>
        <span class="token comment">//旧节点遍历完全，patch c2剩下的节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> nextPos <span class="token operator">=</span> e2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> anchor <span class="token operator">=</span> nextPos <span class="token operator">&lt;</span> l2 <span class="token operator">?</span> c2<span class="token punctuation">[</span>nextPos<span class="token punctuation">]</span><span class="token punctuation">.</span>el <span class="token operator">:</span> parentAnchor<span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> optimized
                        <span class="token operator">?</span> <span class="token function">cloneIfMounted</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                        <span class="token operator">:</span> <span class="token function">normalizeVNode</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> isSVG<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    i<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 4. common sequence + unmount</span>
        <span class="token comment">// (a b) c</span>
        <span class="token comment">// (a b)</span>
        <span class="token comment">// i = 2, e1 = 2, e2 = 1</span>
        <span class="token comment">// a (b c)</span>
        <span class="token comment">// (b c)</span>
        <span class="token comment">// i = 0, e1 = 0, e2 = -1</span>
        <span class="token comment">//新节点遍历完全，卸载老节点上的多余节点</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">unmount</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5. unknown sequence</span>
        <span class="token comment">// [i ... e1 + 1]: a b [c d e] f g</span>
        <span class="token comment">// [i ... e2 + 1]: a b [e d c h] f g</span>
        <span class="token comment">// i = 2, e1 = 4, e2 = 5</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> s1 <span class="token operator">=</span> i<span class="token punctuation">;</span> <span class="token comment">// prev starting index</span>
            <span class="token keyword">const</span> s2 <span class="token operator">=</span> i<span class="token punctuation">;</span> <span class="token comment">// next starting index</span>
            <span class="token comment">// 5.1 build key:index map for newChildren</span>
            <span class="token keyword">const</span> keyToNewIndexMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> s2<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> nextChild <span class="token operator">=</span> <span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> optimized
                    <span class="token operator">?</span> <span class="token function">cloneIfMounted</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token operator">:</span> <span class="token function">normalizeVNode</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> keyToNewIndexMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Duplicate keys found during update:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Make sure keys are unique.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    keyToNewIndexMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 5.2 loop through old children left to be patched and try to patch</span>
            <span class="token comment">// matching nodes &amp; remove nodes that are no longer present</span>
            <span class="token keyword">let</span> j<span class="token punctuation">;</span>
            <span class="token keyword">let</span> patched <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> toBePatched <span class="token operator">=</span> e2 <span class="token operator">-</span> s2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> moved <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> maxNewIndexSoFar <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// used to track whether any node has moved</span>
            <span class="token comment">// works as Map&lt;newIndex, oldIndex&gt;</span>
            <span class="token comment">// Note that oldIndex is offset by +1</span>
            <span class="token comment">// and oldIndex = 0 is a special value indicating the new node has</span>
            <span class="token comment">// no corresponding old node.</span>
            <span class="token comment">// used for determining longest stable subsequence</span>
            <span class="token keyword">const</span> newIndexToOldIndexMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>toBePatched<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> toBePatched<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                newIndexToOldIndexMap<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment">//先遍历老节点</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> s1<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> e1<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//老的子节点</span>
                <span class="token keyword">const</span> prevChild <span class="token operator">=</span> c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

                <span class="token comment">//挂载完成，删除当前老的子节点</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>patched <span class="token operator">&gt;=</span> toBePatched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">unmount</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//获取newIndex</span>
                <span class="token keyword">let</span> newIndex<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>key <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    newIndex <span class="token operator">=</span> keyToNewIndexMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// key-less node, try to locate a key-less node of the same type</span>
                    <span class="token comment">//没有key的节点，尝试去定位一个与其相同类型的节点</span>
                    <span class="token comment">//遍历新节点</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> s2<span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> e2<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">//遍历s2到e2，找出和prevChild类型相同的节点，并将j赋值给newIndex</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndexToOldIndexMap<span class="token punctuation">[</span>j <span class="token operator">-</span> s2<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> c2<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            newIndex <span class="token operator">=</span> j<span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//newIndex不存在，则卸载节点</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndex <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">unmount</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">//新节点存在</span>
                    newIndexToOldIndexMap<span class="token punctuation">[</span>newIndex <span class="token operator">-</span> s2<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//i为s1</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndex <span class="token operator">&gt;=</span> maxNewIndexSoFar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        maxNewIndexSoFar <span class="token operator">=</span> newIndex<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        moved <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">patch</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> c2<span class="token punctuation">[</span>newIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> isSVG<span class="token punctuation">,</span> optimized<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    patched<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 5.3 move and mount</span>
            <span class="token comment">// generate longest stable subsequence only when nodes have moved</span>
            <span class="token comment">//新节点数组中最大升序子集，返回的是index集合</span>
            <span class="token keyword">const</span> increasingNewIndexSequence <span class="token operator">=</span> moved
                <span class="token operator">?</span> <span class="token function">getSequence</span><span class="token punctuation">(</span>newIndexToOldIndexMap<span class="token punctuation">)</span>
                <span class="token operator">:</span> <span class="token constant">EMPTY_ARR</span><span class="token punctuation">;</span>
            j <span class="token operator">=</span> increasingNewIndexSequence<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    
            <span class="token comment">//向后循环，以便我们可以使用最后一个补丁节点作为锚</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> toBePatched <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//新的子节点下标和新的子节点</span>
                <span class="token keyword">const</span> nextIndex <span class="token operator">=</span> s2 <span class="token operator">+</span> i<span class="token punctuation">;</span>
                <span class="token keyword">const</span> nextChild <span class="token operator">=</span> c2<span class="token punctuation">[</span>nextIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token comment">//nextIndex后面一个节点为锚点</span>
                <span class="token keyword">const</span> anchor <span class="token operator">=</span> nextIndex <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> l2 <span class="token operator">?</span> c2<span class="token punctuation">[</span>nextIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el <span class="token operator">:</span> parentAnchor<span class="token punctuation">;</span>
                <span class="token comment">//为0则是新增</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndexToOldIndexMap<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 挂载新节点</span>
                    <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> nextChild<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> isSVG<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>moved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//在没有稳定升序子集的的情况，或者现在的节点不在稳定升序子集里面，则移动</span>
                    <span class="token comment">//i是遍历需要移动节点集合的指针，从后往前 </span>
                    <span class="token comment">//j是从后往前遍历increasingNewIndexSequence的指针</span>
                    <span class="token comment">// j&lt;0则最长升序子集遍历完成 i!== 子序列中的值，说明需要移动</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> i <span class="token operator">!==</span> increasingNewIndexSequence<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">move</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token comment">/* REORDER */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        j<span class="token operator">--</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br></div></div><h3 id="_2-整体逻辑图-2"><a href="#_2-整体逻辑图-2" class="header-anchor">#</a> 2. 整体逻辑图</h3> <p><img src="https://cdn.nlark.com/yuque/0/2020/png/1355506/1598362495092-aec70669-3e56-498e-bddd-80535a20b8c6.png#align=left&amp;display=inline&amp;height=979&amp;margin=%5Bobject%20Object%5D&amp;name=vue3.0domdiff.png&amp;originHeight=979&amp;originWidth=2555&amp;size=187009&amp;status=done&amp;style=none&amp;width=2555" alt="vue3.0domdiff.png">
和vue2.x对比，Vue3.0没有采用双指针遍历的方式，而是单指针循环，先遍历头部节点，直到第一个不同节点；然后再尾部遍历，直到第一个不同的节点。然后做新旧节点是否遍历完成的判断，如果遍历完成则进行挂载或删除。以上情况都不是，则进行核心逻辑对比。Vue3.x中取消了头尾/尾头的比较，只要头尾遇到不同的节点，那么其中的节点都进入未知序列核心逻辑的比较。先看一下核心对比的逻辑图
此处的 unknown sequence 就是上例中的除去头尾相同项的中间项
<img src="https://cdn.nlark.com/yuque/0/2020/png/1355506/1598415762766-3052a521-2758-40ba-8be1-eba02ba0643d.png#align=left&amp;display=inline&amp;height=1047&amp;margin=%5Bobject%20Object%5D&amp;name=Vue3%20dom%20diff%20%20unknown%20sequence.png&amp;originHeight=1047&amp;originWidth=2767&amp;size=325771&amp;status=done&amp;style=none&amp;width=2767" alt="Vue3 dom diff  unknown sequence.png"></p> <h3 id="_3-案例分析-2"><a href="#_3-案例分析-2" class="header-anchor">#</a> 3. 案例分析</h3> <p>还是上面的案例</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>realDom
<span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span> <span class="token number">10</span>
<span class="token comment">//old VNode</span>
s1                           e1
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>
<span class="token comment">//new VNode</span>
s2                            e2
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>头尾比较后，主要是中间项的比较。
oldch:： <code>[2, 3, 4, 5, 6, 7, 8, 9]</code> 
newch：<code>[9, 11, 7, 3, 4, 5, 6, 2]</code> 
结合动图
<img src="/blog/assets/img/vue3-dom-diff.55e5bd94.gif" alt="vue3-dom-diff"></p> <ol><li>首先遍历新的子节点，生成一个新节点自身key和index的映射表： <code>keyToNewIndexMap</code></li></ol> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token number">0</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token number">9</span> <span class="token operator">=&gt;</span> <span class="token number">1</span><span class="token punctuation">}</span>
<span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token number">11</span> <span class="token operator">=&gt;</span> <span class="token number">2</span><span class="token punctuation">}</span>
<span class="token number">2</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token number">7</span> <span class="token operator">=&gt;</span> <span class="token number">3</span><span class="token punctuation">}</span>
<span class="token number">3</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token number">3</span> <span class="token operator">=&gt;</span> <span class="token number">4</span><span class="token punctuation">}</span>
<span class="token number">4</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token number">4</span> <span class="token operator">=&gt;</span> <span class="token number">5</span><span class="token punctuation">}</span>
<span class="token number">5</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token number">5</span> <span class="token operator">=&gt;</span> <span class="token number">6</span><span class="token punctuation">}</span>
<span class="token number">6</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token number">6</span> <span class="token operator">=&gt;</span> <span class="token number">7</span><span class="token punctuation">}</span>
<span class="token number">7</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token number">8</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol start="2"><li>遍历旧节点
<ol><li>通过旧节点的key，在中<code>keyToNewIndexMap</code>查询在新节点index</li> <li>如果newIndex没有，则删除节点</li> <li>如果有，就生成一个 {newIndex : oldIndex+1}映射表 : <code>newIndexToOldIndexMap</code></li></ol></li></ol> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="3"><li>通过 <code>newIndexToOldIndexMap</code> 获取最长升序子序列的index集合， <code>increasingNewIndexSequence</code></li></ol> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="4"><li><p>newch :                             <code>[9, 11, 7, 3, 4, 5, 6, 2]</code></p> <p>newIndexToOldIndexMap:    <code>[9, 0, 7, 3, 4, 5, 6, 2]</code> 
increasingNewIndexSequence:                     <code>[3, 4, 5, 6]</code></p></li></ol> <ul><li>需要比较的项的数量为8，用toBePatched表示，以数组项指针的形式从后往前循环，同时遍历newch和newIndexToOldIndexMap</li> <li>同时最长升序子序列也从后往前遍历，将其遍历的值和上面遍历的数组指针比较</li> <li>newIndexToOldIndexMap指针在increasingNewIndexSequence项中没有的时候，对应的newch中的节点就需要移动；存在的话，则不需移动</li> <li>newIndexToOldIndexMap中值为0的时候，对应的newch中的项就为新增节点</li> <li>锚点为，指针移动到newCh节点的后面节点</li></ul> <p>Vue3.x的dom diff通过和最长升序子序列的的对比，将节点移动操作最小化，大大提升了效率。感兴趣的可以研究下<a href="https://en.wikipedia.org/wiki/Longest_increasing_subsequence" target="_blank" rel="noopener noreferrer">最长升序子序列<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="_4-最长升序子序列算法"><a href="#_4-最长升序子序列算法" class="header-anchor">#</a> 4.最长升序子序列算法</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getSequence</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> p <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> u<span class="token punctuation">,</span> v<span class="token punctuation">,</span> c<span class="token punctuation">;</span>
    <span class="token keyword">const</span> len <span class="token operator">=</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> arrI <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            j <span class="token operator">=</span> result<span class="token punctuation">[</span>result<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> arrI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> j<span class="token punctuation">;</span>
                result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            u <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            v <span class="token operator">=</span> result<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>u <span class="token operator">&lt;</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u <span class="token operator">+</span> v<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>result<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> arrI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    u <span class="token operator">=</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    v <span class="token operator">=</span> c<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>arrI <span class="token operator">&lt;</span> arr<span class="token punctuation">[</span>result<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">[</span>u <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                result<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    u <span class="token operator">=</span> result<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    v <span class="token operator">=</span> result<span class="token punctuation">[</span>u <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>u<span class="token operator">--</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">;</span>
        v <span class="token operator">=</span> p<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">10/29/2020, 1:21:25 AM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/blog/soundcode/webpack/webpack5.html">
        webpack整体架构
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.debabb2d.js" defer></script><script src="/blog/assets/js/2.9886cf03.js" defer></script><script src="/blog/assets/js/4.251b1637.js" defer></script>
  </body>
</html>
